{{ if ne .Values.global.size "demo" }}
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i1
  name: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i1
  namespace: {{ .Values.global.namespace | default "erda-system" }}
spec:
  podManagementPolicy: OrderedReady
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i1
  serviceName: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i1
  template:
    metadata:
      labels:
        app: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i1
    spec:
      tolerations:
        - operator: Exists
      {{- if .Values.nodematchExpressions }}
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                {{- range $_, $value := .Values.nodematchExpressions }}
                  - key: {{ $value.key }}
                    operator: {{ $value.operator }}
                {{- end }}
      {{- end }}
      containers:
        - name: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i1
          image: {{ .Values.global.image.repository }}/addon-zookeeper:{{ .Values.zookeeper.version }}
          imagePullPolicy: {{ .Values.global.image.imagePullPolicy  | default "IfNotPresent" }}
          ports:
          - containerPort: 2181
            protocol: TCP
          - containerPort: 2888
            protocol: TCP
          - containerPort: 3888
            protocol: TCP
          env:
          - name: DICE_PLATFORM_ADDON
            value: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i1
          - name: ZOO_AUTO_INTERVAL
            value: '2'
          - name: ZOO_AUTO_RETAINCOUNT
            value: '3'
          - name: ZOO_CONF_DIR
            value: "/conf"
          - name: ZOO_DATA_DIR
            value: "/data"
          - name: ZOO_DATA_LOG_DIR
            value: "/datalog"
          - name: ZOO_INIT_LIMIT
            value: '5'
          - name: ZOO_MAX_CLIENT_CNXNS
            value: '60'
          - name: ZOO_MY_ID
            value: '1'
          - name: ZOO_PORT
            value: '2181'
          - name: ZOO_SERVERS
            value: server.2={{ .Values.zookeeper.name | default "addon-zookeeper" }}-i2.{{ .Values.global.namespace | default "erda-system" }}.svc.cluster.local:2888:3888 server.3={{ .Values.zookeeper.name | default "addon-zookeeper" }}-i3.{{ .Values.global.namespace | default "erda-system" }}.svc.cluster.local:2888:3888 server.1=0.0.0.0:2888:3888
          - name: ZOO_SYNC_LIMIT
            value: '2'
          - name: ZOO_TICK_TIME
            value: '6000'
          - name: ZOO_USER
            value: zookeeper
          - name: POD_IP
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: status.podIP
          - name: HOST_IP
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: status.hostIP
          resources:
            requests:
              cpu: {{ .Values.zookeeper.resources.requests.cpu | default "0.1" | quote }}
              memory: {{ .Values.zookeeper.resources.requests.memory | default "10Mi" | quote }}
            limits:
              cpu: {{ .Values.zookeeper.resources.limits.cpu |  default "1" | quote }}
              memory: {{ .Values.zookeeper.resources.limits.memory | default "400Mi" | quote }}
          volumeMounts:
          - name: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i1
            mountPath: /data
          livenessProbe:
            tcpSocket:
              port: 2181
            initialDelaySeconds: 1
            timeoutSeconds: 10
            periodSeconds: 15
            successThreshold: 1
            failureThreshold: 9
  updateStrategy:
    type: RollingUpdate
  volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      labels:
        app: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i1
      name: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i1
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 100Gi
      storageClassName: {{ .Values.global.storageClassName | default "dice-local-volume" }}
      volumeMode: Filesystem
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i2
  name: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i2
  namespace: {{ .Values.global.namespace | default "erda-system" }}
spec:
  podManagementPolicy: OrderedReady
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i2
  serviceName: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i2
  template:
    metadata:
      labels:
        app: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i2
    spec:
      tolerations:
        - operator: Exists
      {{- if .Values.nodematchExpressions }}
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                {{- range $_, $value := .Values.nodematchExpressions }}
                  - key: {{ $value.key }}
                    operator: {{ $value.operator }}
                {{- end }}
      {{- end }}
      containers:
        - name: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i2
          image: {{ .Values.global.image.repository }}/addon-zookeeper:{{ .Values.zookeeper.version }}
          imagePullPolicy: {{ .Values.global.image.imagePullPolicy  | default "IfNotPresent" }}
          ports:
          - containerPort: 2181
            protocol: TCP
          - containerPort: 2888
            protocol: TCP
          - containerPort: 3888
            protocol: TCP
          env:
          - name: DICE_PLATFORM_ADDON
            value: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i2
          - name: ZOO_AUTO_INTERVAL
            value: '2'
          - name: ZOO_AUTO_RETAINCOUNT
            value: '3'
          - name: ZOO_CONF_DIR
            value: "/conf"
          - name: ZOO_DATA_DIR
            value: "/data"
          - name: ZOO_DATA_LOG_DIR
            value: "/datalog"
          - name: ZOO_INIT_LIMIT
            value: '5'
          - name: ZOO_MAX_CLIENT_CNXNS
            value: '60'
          - name: ZOO_MY_ID
            value: '2'
          - name: ZOO_PORT
            value: '2181'
          - name: ZOO_SERVERS
            value: server.1={{ .Values.zookeeper.name | default "addon-zookeeper" }}-i1.{{ .Values.global.namespace | default "erda-system" }}.svc.cluster.local:2888:3888 server.3={{ .Values.zookeeper.name | default "addon-zookeeper" }}-i3.{{ .Values.global.namespace | default "erda-system" }}.svc.cluster.local:2888:3888 server.2=0.0.0.0:2888:3888
          - name: ZOO_SYNC_LIMIT
            value: '2'
          - name: ZOO_TICK_TIME
            value: '6000'
          - name: ZOO_USER
            value: zookeeper
          - name: POD_IP
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: status.podIP
          - name: HOST_IP
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: status.hostIP
          resources:
            requests:
              cpu: {{ .Values.zookeeper.resources.requests.cpu | default "0.1" | quote }}
              memory: {{ .Values.zookeeper.resources.requests.memory | default "10Mi" | quote }}
            limits:
              cpu: {{ .Values.zookeeper.resources.limits.cpu |  default "1" | quote }}
              memory: {{ .Values.zookeeper.resources.limits.memory | default "400Mi" | quote }}
          volumeMounts:
          - name: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i2
            mountPath: /data
          livenessProbe:
            tcpSocket:
              port: 2181
            initialDelaySeconds: 1
            timeoutSeconds: 10
            periodSeconds: 15
            successThreshold: 1
            failureThreshold: 9
  updateStrategy:
    type: RollingUpdate
  volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      labels:
        app: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i2
      name: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i2
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 100Gi
      storageClassName: {{ .Values.global.storageClassName | default "dice-local-volume" }}
      volumeMode: Filesystem
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i3
  name: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i3
  namespace: {{ .Values.global.namespace | default "erda-system" }}
spec:
  podManagementPolicy: OrderedReady
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i3
  serviceName: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i3
  template:
    metadata:
      labels:
        app: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i3
    spec:
      tolerations:
        - operator: Exists
      {{- if .Values.nodematchExpressions }}
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                {{- range $_, $value := .Values.nodematchExpressions }}
                  - key: {{ $value.key }}
                    operator: {{ $value.operator }}
                {{- end }}
      {{- end }}
      containers:
        - name: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i3
          image: {{ .Values.global.image.repository }}/addon-zookeeper:{{ .Values.zookeeper.version }}
          imagePullPolicy: {{ .Values.global.image.imagePullPolicy  | default "IfNotPresent" }}
          ports:
          - containerPort: 2181
            protocol: TCP
          - containerPort: 2888
            protocol: TCP
          - containerPort: 3888
            protocol: TCP
          env:
          - name: DICE_PLATFORM_ADDON
            value: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i3
          - name: ZOO_AUTO_INTERVAL
            value: '2'
          - name: ZOO_AUTO_RETAINCOUNT
            value: '3'
          - name: ZOO_CONF_DIR
            value: "/conf"
          - name: ZOO_DATA_DIR
            value: "/data"
          - name: ZOO_DATA_LOG_DIR
            value: "/datalog"
          - name: ZOO_INIT_LIMIT
            value: '5'
          - name: ZOO_MAX_CLIENT_CNXNS
            value: '60'
          - name: ZOO_MY_ID
            value: '3'
          - name: ZOO_PORT
            value: '2181'
          - name: ZOO_SERVERS
            value: server.1={{ .Values.zookeeper.name | default "addon-zookeeper" }}-i1.{{ .Values.global.namespace | default "erda-system" }}.svc.cluster.local:2888:3888 server.2={{ .Values.zookeeper.name | default "addon-zookeeper" }}-i2.{{ .Values.global.namespace | default "erda-system" }}.svc.cluster.local:2888:3888 server.3=0.0.0.0:2888:3888
          - name: ZOO_SYNC_LIMIT
            value: '2'
          - name: ZOO_TICK_TIME
            value: '6000'
          - name: ZOO_USER
            value: zookeeper
          - name: POD_IP
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: status.podIP
          - name: HOST_IP
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: status.hostIP
          resources:
            requests:
              cpu: {{ .Values.zookeeper.resources.requests.cpu | default "0.1" | quote }}
              memory: {{ .Values.zookeeper.resources.requests.memory | default "10Mi" | quote }}
            limits:
              cpu: {{ .Values.zookeeper.resources.limits.cpu |  default "1" | quote }}
              memory: {{ .Values.zookeeper.resources.limits.memory | default "400Mi" | quote }}
          volumeMounts:
          - name: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i3
            mountPath: /data
          livenessProbe:
            tcpSocket:
              port: 2181
            initialDelaySeconds: 1
            timeoutSeconds: 10
            periodSeconds: 15
            successThreshold: 1
            failureThreshold: 9
  updateStrategy:
    type: RollingUpdate
  volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      labels:
        app: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i3
      name: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i3
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 100Gi
      storageClassName: {{ .Values.global.storageClassName | default "dice-local-volume" }}
      volumeMode: Filesystem
---
kind: Service
apiVersion: v1
metadata:
  name: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i1
  namespace: {{ .Values.global.namespace | default "erda-system" }}
spec:
  ports:
  - name: {{ default "addon-zookeeper" .Values.zookeeper.name }}-i1-tcp-2181
    protocol: TCP
    port: 2181
  - name: {{ default "addon-zookeeper" .Values.zookeeper.name }}-i1-tcp-2888
    protocol: TCP
    port: 2888
  - name: {{ default "addon-zookeeper" .Values.zookeeper.name }}-i1-tcp-3888
    protocol: TCP
    port: 3888
  selector:
    app: {{ default "addon-zookeeper" .Values.zookeeper.name }}-i1
---
kind: Service
apiVersion: v1
metadata:
  name: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i2
  namespace: {{ .Values.global.namespace | default "erda-system" }}
spec:
  ports:
  - name: {{ default "addon-zookeeper" .Values.zookeeper.name }}-i2-tcp-2181
    protocol: TCP
    port: 2181
  - name: {{ default "addon-zookeeper" .Values.zookeeper.name }}-i2-tcp-2888
    protocol: TCP
    port: 2888
  - name: {{ default "addon-zookeeper" .Values.zookeeper.name }}-i2-tcp-3888
    protocol: TCP
    port: 3888
  selector:
    app: {{ default "addon-zookeeper" .Values.zookeeper.name }}-i2
---
kind: Service
apiVersion: v1
metadata:
  name: {{ .Values.zookeeper.name | default "addon-zookeeper" }}-i3
  namespace: {{ .Values.global.namespace | default "erda-system" }}
spec:
  ports:
  - name: {{ default "addon-zookeeper" .Values.zookeeper.name }}-i3-tcp-2181
    protocol: TCP
    port: 2181
  - name: {{ default "addon-zookeeper" .Values.zookeeper.name }}-i3-tcp-2888
    protocol: TCP
    port: 2888
  - name: {{ default "addon-zookeeper" .Values.zookeeper.name }}-i3-tcp-3888
    protocol: TCP
    port: 3888
  selector:
    app: {{ default "addon-zookeeper" .Values.zookeeper.name }}-i3
{{- end }}
